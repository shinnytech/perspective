var J=Object.create;var b=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var $=Object.getPrototypeOf,H=Object.prototype.hasOwnProperty;var C=t=>b(t,"__esModule",{value:!0});var G=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),X=(t,e)=>{C(t);for(var r in e)b(t,r,{get:e[r],enumerable:!0})},Z=(t,e,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Y(e))!H.call(t,i)&&i!=="default"&&b(t,i,{get:()=>e[i],enumerable:!(r=K(e,i))||r.enumerable});return t},L=t=>Z(C(b(t!=null?J($(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var W=G((ke,M)=>{M.exports.default={types:{float:{filter_operator:"==",aggregate:"sum",format:{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2}},string:{filter_operator:"==",aggregate:"count"},integer:{filter_operator:"==",aggregate:"sum",format:{}},boolean:{filter_operator:"==",aggregate:"count"},datetime:{filter_operator:"==",aggregate:"count",format:{week:"numeric",year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"},null_value:-1},date:{filter_operator:"==",aggregate:"count",format:{week:"numeric",year:"numeric",month:"numeric",day:"numeric"},null_value:-1}}}});var N=G((Ee,d)=>{var D=W().default;d.exports.get_types=function(){return Object.keys(d.exports.get_config().types)};d.exports.get_type_config=function(t){let e={};if(d.exports.get_config().types[t]&&Object.assign(e,d.exports.get_config().types[t]),e.type){let r=d.exports.get_type_config(e.type);return Object.assign(r,e),r}else return e};function O(t){return t&&typeof t=="object"&&!Array.isArray(t)}function w(t,...e){if(!e.length)return t;let r=e.shift();if(O(t)&&O(r))for(let i in r)O(r[i])?(t[i]||Object.assign(t,{[i]:{}}),w(t[i],r[i])):Object.assign(t,{[i]:r[i]});return w(t,...e)}globalThis.__PERSPECTIVE_CONFIG__=void 0;d.exports.override_config=function(t){globalThis.__PERSPECTIVE_CONFIG__&&console.warn("Config already initialized!"),globalThis.__PERSPECTIVE_CONFIG__=w(D,t)};d.exports.get_config=function(){return globalThis.__PERSPECTIVE_CONFIG__||(globalThis.__PERSPECTIVE_CONFIG__=w(D,globalThis.__TEMPLATE_CONFIG__||{})),globalThis.__PERSPECTIVE_CONFIG__}});var x={};X(x,{COLUMN_SEPARATOR_STRING:()=>_e,CONFIG_ALIASES:()=>ee,CONFIG_VALID_KEYS:()=>te,DATA_TYPES:()=>Q,FILTER_OPERATORS:()=>n,SORT_ORDERS:()=>ie,SORT_ORDER_IDS:()=>ne,TYPE_AGGREGATES:()=>oe,TYPE_FILTERS:()=>le});var Q={integer:"integer",float:"float",string:"string",boolean:"boolean",date:"date",datetime:"datetime",object:"object"},ee={row_pivot:"group_by","row-pivot":"group_by","row-pivots":"group_by",col_pivot:"split_by",col_pivots:"split_by",column_pivot:"split_by","column-pivot":"split_by","column-pivots":"split_by",filters:"filter",sorts:"sort"},te=["viewport","group_by","split_by","aggregates","columns","filter","sort","computed_columns","expressions","group_by_depth","split_by_depth","filter_op"],q=["any","avg","abs sum","count","distinct count","dominant","first by index","last by index","last minus first","last","high","join","low","high minus low","mean","median","pct sum parent","pct sum grand total","stddev","sum","sum abs","sum not null","unique","var"],v=["any","count","distinct count","distinct leaf","dominant","first by index","join","last by index","last","unique"],re=["any","count","distinct count","distinct leaf","dominant","first by index","last by index","last","unique"],ie=["none","asc","desc","col asc","col desc","asc abs","desc abs","col asc abs","col desc abs"],ne=[2,0,1,0,1,3,4,3,4],oe={string:v,float:q,integer:q,boolean:re,datetime:v,date:v},n={lessThan:"<",greaterThan:">",equals:"==",lessThanOrEquals:"<=",greaterThanOrEquals:">=",doesNotEqual:"!=",isNull:"is null",isNotNull:"is not null",isIn:"in",isNotIn:"not in",contains:"contains",bitwiseAnd:"&",bitwiseOr:"|",and:"and",or:"or",beginsWith:"begins with",endsWith:"ends with",inRecent:"in recent"},se=[n.bitwiseAnd,n.bitwiseOr,n.equals,n.doesNotEqual,n.or,n.and,n.isNull,n.isNotNull],F=[n.lessThan,n.greaterThan,n.equals,n.lessThanOrEquals,n.greaterThanOrEquals,n.doesNotEqual,n.isNull,n.isNotNull],ae=[n.equals,n.contains,n.doesNotEqual,n.isIn,n.isNotIn,n.beginsWith,n.endsWith,n.isNull,n.isNotNull],z=[n.lessThan,n.greaterThan,n.equals,n.lessThanOrEquals,n.greaterThanOrEquals,n.doesNotEqual,n.isNull,n.isNotNull,n.inRecent],_e="|",le={string:ae,float:F,integer:F,boolean:se,datetime:z,date:z};var E=L(N());var T=new WeakMap,A=0;function f(t,e){return function(){let r,i=()=>{},s=Array.prototype.slice.call(arguments,0,arguments.length);for(let p=s.length-1;p>=0;p--)typeof s[p]=="function"&&(r=s.splice(p,1)[0]);let l=T.get(r);T.delete(r);let u={cmd:e||"view_method",name:this._name,method:t,args:s,subscribe:!0,callback_id:l};this._worker.post(u,r,i),this._worker.unsubscribe(e,r)}}function h(t,e){return function(){let r,i=()=>{},s=Array.prototype.slice.call(arguments,0,arguments.length);for(let u=s.length-1;u>=0;u--)typeof s[u]=="function"&&(r=s.splice(u,1)[0]);A++,T.set(r,A);let l={cmd:e||"view_method",name:this._name,method:t,args:s,subscribe:!0,callback_id:A};this._worker.post(l,r,i,!0)}}function o(t,e){return function(){var r=Array.prototype.slice.call(arguments,0,arguments.length);return new Promise(function(i,s){var l={cmd:e||"view_method",name:this._name,method:t,args:r,subscribe:!1};this._worker.post(l,i,s)}.bind(this))}}function a(t,e,r){return new Promise((i,s)=>{this._worker=t,this._name=Math.random()+"",this._worker.post({cmd:"view",view_name:this._name,table_name:e,config:r},()=>{i(this)},s),this._worker._initialized===!0&&!this._worker._features?.wait_for_response&&i(this)})}function pe(t,e){this._worker=t,this._name=e}pe.prototype=a.prototype;a.prototype.get_config=o("get_config");a.prototype.get_min_max=o("get_min_max");a.prototype.to_json=o("to_json");a.prototype.to_arrow=o("to_arrow");a.prototype.to_columns=o("to_columns");a.prototype.to_csv=o("to_csv");a.prototype.schema=o("schema");a.prototype.expression_schema=o("expression_schema");a.prototype.column_paths=o("column_paths");a.prototype.num_columns=o("num_columns");a.prototype.num_rows=o("num_rows");a.prototype.set_depth=o("set_depth");a.prototype.get_row_expanded=o("get_row_expanded");a.prototype.expand=o("expand");a.prototype.collapse=o("collapse");a.prototype.delete=o("delete");a.prototype.col_to_js_typed_array=o("col_to_js_typed_array");a.prototype.on_update=h("on_update","view_method",!0);a.prototype.remove_update=f("remove_update","view_method",!0);a.prototype.on_delete=h("on_delete","view_method",!0);a.prototype.remove_delete=f("remove_delete","view_method",!0);function k(t){let e=t;do for(let r of Object.getOwnPropertyNames(e)){let i=t[r];r!=="constructor"&&typeof i=="function"&&(t[r]=i.bind(t))}while(e=e!==Object&&Object.getPrototypeOf(e))}String.prototype.includes||(String.prototype.includes=function(t,e){return typeof e!="number"&&(e=0),e+t.length>this.length?!1:this.indexOf(t,e)!==-1});Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(t,e){if(this==null)throw new TypeError('"this" is null or not defined');var r=Object(this),i=r.length>>>0;if(i===0)return!1;var s=e|0,l=Math.max(s>=0?s:i-Math.abs(s),0);function u(p,c){return p===c||typeof p=="number"&&typeof c=="number"&&isNaN(p)&&isNaN(c)}for(;l<i;){if(u(r[l],t))return!0;l++}return!1}});function _(t,e,r){return new Promise((i,s)=>{this._worker=t,this._name=r.name||Math.random()+"",k(this),e.to_arrow?(this._worker.post({cmd:"table",name:this._name,args:[],options:r||{}}),e.to_arrow().then(l=>{this._worker.post({cmd:"table",name:this._name,args:[l],options:r||{}},()=>{e.on_update(u=>{this.update(u.delta)},{mode:"row"}),i(this)},s)})):this._worker.post({cmd:"table",name:this._name,args:[e],options:r||{}},()=>{i(this)},s),this._worker._initialized===!0&&!this._worker._features?.wait_for_response&&i(this)})}_.prototype.type="table";function I(t,e){this._worker=t,this._name=e}I.prototype=_.prototype;_.prototype.view=function(t){return new a(this._worker,this._name,t)};_.prototype.get_index=o("get_index","table_method");_.prototype.get_limit=o("get_limit","table_method");_.prototype.make_port=o("make_port","table_method");_.prototype.remove_port=o("remove_port","table_method");_.prototype.schema=o("schema","table_method");_.prototype.validate_expressions=o("validate_expressions","table_method");_.prototype.is_valid_filter=o("is_valid_filter","table_method");_.prototype.size=o("size","table_method");_.prototype.columns=o("columns","table_method");_.prototype.clear=o("clear","table_method");_.prototype.replace=o("replace","table_method");_.prototype.delete=o("delete","table_method");_.prototype.on_delete=h("on_delete","table_method",!0);_.prototype.remove=o("remove","table_method");_.prototype.remove_delete=f("remove_delete","table_method",!0);_.prototype.update=function(t,e){return new Promise((r,i)=>{this._worker.post({name:this._name,cmd:"table_method",method:"update",args:[t,e||{}]},r,i,!1)})};_.prototype.execute=function(t){this._worker.post({cmd:"table_execute",name:this._name,f:t.toString()})};var m=class{constructor(){this._initialized=!1,this._worker={initialized:{value:!1},transferable:!1,msg_id:0,handlers:{},messages:[]},k(this)}unsubscribe(e,r){for(let i of Object.keys(this._worker.handlers))this._worker.handlers[i].resolve===r&&delete this._worker.handlers[i]}post(e,r,i,s=!1){++this._worker.msg_id,(r||i)&&(this._worker.handlers[this._worker.msg_id]={resolve:r,reject:i,keep_alive:s}),e.id=this._worker.msg_id,this._worker.initialized.value?this.send(e):this._worker.messages.push(()=>{this.send(e),(e.cmd==="table"||e.cmd==="view")&&!this._features?.wait_for_response&&r&&r()})}async memory_usage(){return await new Promise((e,r)=>{this.post({cmd:"memory_usage"},e,r)})}initialize_profile_thread(){this._worker.initialized.value?this.send({id:-1,cmd:"init_profile_thread"}):this._worker.messages.push(()=>this.send({id:-1,cmd:"init_profile_thread"}))}send(){throw new Error("send() not implemented")}async open_table(e){return new I(this,e)}_handle(e){if(!this._worker.initialized.value){if(!this._initialized&&typeof document!="undefined"&&document&&typeof window!==void 0&&window){try{let i=document.createEvent("Event");i.initEvent("perspective-ready",!1,!0),window.dispatchEvent(i)}catch{}this._initialized=!0}let r=this._worker.messages;if(this._worker.initialized.value=!0,this._worker.messages=[],e.data?.data){this._features={};for(let i of e.data.data)this._features[i]=!0}if(r)for(let i in r)r.hasOwnProperty(i)&&r[i]()}if(e.data.id){let r=this._worker.handlers[e.data.id];r&&(e.data.error?r.reject(e.data.error):r.resolve(e.data.data),r.keep_alive||delete this._worker.handlers[e.data.id])}}table(e,r){return new _(this,e,r||{})}terminate(){this._worker.terminate(),this._worker=void 0}};var B=3e4,S=class extends m{constructor(e){super();this._ws=e,this._ws.binaryType="arraybuffer",this._full_binary,this._total_chunk_length=0,this._pending_binary_length=0,this._ws.onopen=()=>{this.send({id:-1,cmd:"init"})};let r=()=>{this._ws.send("ping"),setTimeout(r,B)};setTimeout(r,B),this._ws.onmessage=i=>{if(i.data!=="pong")if(this._pending_binary){let s=i.data;if(this._full_binary.set(new Uint8Array(s),this._total_chunk_length),this._total_chunk_length+=s.byteLength,this._total_chunk_length===this._pending_binary_length)s=this._full_binary.buffer;else return;let l={data:{id:this._pending_binary,data:s}};if(this._pending_port_id!==void 0){let u={port_id:this._pending_port_id,delta:s};l.data.data=u}this._handle(l),delete this._pending_binary,delete this._pending_binary_length,delete this._pending_port_id,this._total_chunk_length=0,this._full_binary=null}else i=JSON.parse(i.data),i.binary_length?(this._pending_binary=i.id,this._pending_binary_length=i.binary_length,i.data&&i.data.port_id!==void 0&&(this._pending_port_id=i.data.port_id),this._full_binary=new Uint8Array(this._pending_binary_length)):this._handle({data:i})}}send(e){if(e.args&&e.args.length>0&&e.args[0]instanceof ArrayBuffer&&e.args[0].byteLength!==void 0){let r=e;e.binary_length=e.args[0].byteLength,this._ws.send(JSON.stringify(r)),this._ws.send(e.args[0]);return}this._ws.send(JSON.stringify(e))}terminate(){return new Promise(e=>{this._ws.onclose=e,this._ws.close()})}};var U=L(N());import{Decompress as ue}from"fflate";import de from"@finos/perspective/src/js/perspective.worker.js";import ce from"@finos/perspective/dist/pkg/esm/perspective.cpp.wasm";var fe=`Perspective has been compiled in "inline" mode.  While Perspective's runtime performance is not affected, you may see smaller assets size and faster engine initial load time using "@finos/perspective-webpack-plugin" to build your application.
https://perspective.finos.org/docs/md/js.html`;function V(t){return new Uint32Array(t.slice(0,4))[0]==559903}var R=function(){let t;return function(){return t||(t=new class{async worker(){return await de()}async wasm(){let e=await ce,r=[],i=0,s=new ue(p=>{p&&(i+=p.byteLength,r.push(p))});if(e.buffer&&e.buffer instanceof ArrayBuffer)console.warn(fe),V(e.buffer)?s.push(e,!0):(i=e.byteLength,r=[e]);else if(e instanceof ArrayBuffer)i=e.byteLength,r=[new Uint8Array(e)];else{let c=(await fetch(e)).body.getReader(),g=0;for(;;){let{value:y,done:P}=await c.read();if(P)break;g===0&&V(y.buffer)||g===1?(g=1,s.push(y,P)):(g=2,i+=y.byteLength,r.push(y))}}let l=0,u=new Uint8Array(i);for(let p of r)u.set(p,l),l+=p.byteLength;return this._wasm=u.buffer,this._wasm}}),t}}(),j=class extends m{constructor(e){e&&(0,U.override_config)(e);super();this.register()}async register(){let e,r={cmd:"init",config:(0,E.get_config)()};if(typeof WebAssembly=="undefined")throw new Error("WebAssembly not supported.");[e,r.buffer]=await Promise.all([R().worker(),R().wasm()]);for(var i in this._worker)e[i]=this._worker[i];this._worker=e,this._worker.addEventListener("message",this._handle.bind(this)),this._worker.postMessage(r),this._detect_transferable()}send(e){this._worker.transferable&&e.args&&e.args[0]instanceof ArrayBuffer?this._worker.postMessage(e,[e.args[0]]):this._worker.postMessage(e)}terminate(){this._worker.terminate(),this._worker=void 0}_detect_transferable(){var e=new ArrayBuffer(1);this._worker.postMessage(e,[e]),this._worker.transferable=e.byteLength===0,this._worker.transferable?console.debug("Transferable support detected"):console.warn("Transferable support not detected")}},he=function(){let t,e;return{getInstance:function(r){t===void 0&&(t=new j(r));let i=JSON.stringify(r);if(e&&i!==e)throw new Error("Configuration object for shared_worker() has changed - this is probably a bug in your application.");return e=i,t}}}(),We=E.get_type_config;function me(t){return R().set(t)}function ge(t){return new j(t)}function ye(t=window.location.origin.replace("http","ws")){return new S(new WebSocket(t))}function be(t){return he.getInstance(t)}var De={override:me,worker:ge,websocket:ye,shared_worker:be,...Object.keys(x)};export{De as default,We as get_type_config,me as override,be as shared_worker,ye as websocket,ge as worker};
//# sourceMappingURL=perspective.js.map
